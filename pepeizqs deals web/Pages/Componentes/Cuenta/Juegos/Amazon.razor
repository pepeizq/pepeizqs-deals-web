@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.Data.SqlClient
@using Microsoft.Data.Sqlite
@using System.Text
@using System.Net.Http.Headers
@using global::Juegos
@using pepeizqs_deals_web.Areas.Identity.Data

@inject UserManager<Usuario> UserManager
@inject IHttpContextAccessor HttpContextAccessor

<style>
    .cargando {
    width: 48px;
    height: 48px;
    border: 5px solid var(--colorTexto);
    border-bottom-color: transparent;
    border-radius: 50%;
    display: inline-block;
    box-sizing: border-box;
    animation: rotation 1s linear infinite;
    }

    @@keyframes rotation {
    0% {
    transform: rotate(0deg);
    }

    100% {
    transform: rotate(360deg);
    }
    }
</style>

@if (usuario != null)
{
    <div style="display: flex; flex-direction: column; gap: 20px;">
        <div style="background-color: var(--fondoOscuro); border: 1px solid var(--fondoBotonPequeño); padding: 30px;">
            <div style="display: flex; align-items: center; gap: 20px; text-align: left;">
                <img src="@JuegoDRM2.SacarImagen(JuegoDRM.Amazon)" style="max-width: 40px; max-height: 40px;" />

                <div>
                    <div style="font-size: 18px;">
                        @JuegoDRM2.DevolverDRM(JuegoDRM.Amazon)
                    </div>

                    <div style="font-size: 14px;">
                        @Herramientas.Idiomas.BuscarTexto(idioma, "String11", "AccountGames")
                    </div>
                </div>
            </div>

            <hr />

            <div style="display: flex; align-items: center; gap: 20px;">
                @{
                    int cantidadJuegos = 0;

                    if (string.IsNullOrEmpty(usuario.AmazonGames) == false)
                    {
                        cantidadJuegos = Herramientas.Listados.Generar(usuario.AmazonGames).Count;
                    }

                    <div style="background-color: var(--fondoBien); padding: 10px 20px;">
                        @string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String8", "AccountGames"), cantidadJuegos.ToString())
                    </div>
                }

                @if (usuario.AmazonLastImport != null)
                {
                    <div>
                        @Herramientas.Idiomas.BuscarTexto(idioma, "String7", "AccountGames") @Herramientas.Calculadora.DiferenciaTiempo(usuario.AmazonLastImport, idioma)
                    </div>
                }

                @if (cantidadJuegos > 0)
                {
                    <div style="margin-left: auto;">
                        <button class="boton" style="font-size: 16px; padding: 10px 20px; width: fit-content;" @onclick="@(e => BorrarJuegos(e))">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                }
            </div>
        </div>

        <div style="background-color: var(--fondoOscuro); border: 1px solid var(--fondoBotonPequeño); padding: 30px;">
            <div style="font-size: 18px;">
                @Herramientas.Idiomas.BuscarTexto(idioma, "String15", "AccountGames")
            </div>

            <div style="display: flex; flex-direction: column; gap: 20px; margin-top: 20px; padding: 20px; background-color: var(--fondoMinimo); border: 1px solid var(--fondoBotonPequeño);">
                <label>@string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String17", "AccountGames"), "Amazon Games")</label>

                @if (trabajando == false)
                {
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <button @onclick="@(e => MostrarAmazon(e))" title="Amazon Launcher" class="boton-pestañas" style="font-size: 16px; padding: 0px; width: fit-content; height: 60px;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 15px; justify-content: center; padding: 15px 20px;">
                                    <img src="@JuegoDRM2.SacarImagen(JuegoDRM.Amazon)" style="max-width: 30px; max-height: 30px;" />

                                    @if (mostrarAmazon == true)
                                    {
                                        <div>
                                            Amazon Launcher
                                        </div>  
                                    }
                                </div>

                                @if (mostrarAmazon == true)
                                {
                                    <div style="border: 1px solid var(--colorTexto);"/>
                                }
                            </div>
                        </button>

                        <button @onclick="@(e => MostrarGogGalaxy(e))" title="GOG Galaxy" class="boton-pestañas" style="font-size: 16px; padding: 0px; width: fit-content; height: 60px;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 15px; justify-content: center; padding: 15px 20px;">
                                    <img src="/imagenes/otros/goggalaxy.webp" style="max-width: 30px; max-height: 30px;" />

                                    @if (mostrarGogGalaxy == true)
                                    {
                                        <div>
                                            GOG Galaxy
                                        </div>
                                    }
                                </div>

                                @if (mostrarGogGalaxy == true)
                                {
                                    <div style="border: 1px solid var(--colorTexto);"/>
                                }
                            </div>
                        </button>

                        <button @onclick="@(e => MostrarPlaynite(e))" title="Playnite" class="boton-pestañas" style="font-size: 16px; padding: 0px; width: fit-content; height: 60px;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 15px; justify-content: center; padding: 15px 20px;">
                                    <img src="/imagenes/otros/playnite.webp" style="max-width: 30px; max-height: 30px;" />

                                    @if (mostrarPlaynite == true)
                                    {
                                        <div>
                                            Playnite
                                        </div> 
                                    }
                                </div>

                                @if (mostrarPlaynite == true)
                                {
                                    <div style="border: 1px solid var(--colorTexto);"/>
                                }
                            </div>
                        </button>

                        <button @onclick="@(e => MostrarHeroicGames(e))" title="Heroic Games" class="boton-pestañas" style="font-size: 16px; padding: 0px; width: fit-content; height: 60px;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 15px; justify-content: center; padding: 15px 20px;">
                                    <img src="/imagenes/otros/heroic.webp" style="max-width: 30px; max-height: 30px;" />

                                    @if (mostrarHeroicGames == true)
                                    {
                                        <div>
                                            Heroic Games
                                        </div> 
                                    }
                                </div>

                                @if (mostrarHeroicGames == true)
                                {
                                    <div style="border: 1px solid var(--colorTexto);"/>
                                }
                            </div>
                        </button>
                    </div/>
                }

                @if (mostrarAmazon == true)
                {
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-left: 5px;">
                           <i class="fa-brands fa-windows"></i>
                           <div>
                               Windows
                           </div>
                        </div>

                        <ul style="display: grid; gap: 15px; margin-bottom: 30px;">
                            <li>
                                @string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String19", "AccountGames"), "GameUserInteractionsInfo.sqlite", "%LOCALAPPDATA%\\Amazon Games\\Data\\Games\\Sql\\")
                            </li>

                            <li>
                                <a href="https://support.microsoft.com/en-us/windows/file-explorer-in-windows-ef370130-1cca-9dc5-e0df-2f7416fe1cb1#ID0EDBBBBBFD-button" target="_blank" style="text-decoration: none;">@Herramientas.Idiomas.BuscarTexto(idioma, "String20", "AccountGames")</a>
                            </li>

                            <li>
                                @Herramientas.Idiomas.BuscarTexto(idioma, "String22", "AccountGames")
                            </li>
                        </ul>

                        @if (trabajando == false)
                        {
                            <label class="boton" style="cursor: pointer; font-size: 16px; width: fit-content; padding: 10px 15px;">
                                <InputFile OnChange="AmazonCargarFichero" accept=".sqlite" hidden />
                                @string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String23", "AccountGames"), "GameUserInteractionsInfo.sqlite")
                            </label>

                            @if (importados > 0)
                            {
                                <div style="margin-top: 20px;">@string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String24", "AccountGames"), importados)</div>
                            }
                        }
                        else
                        {
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <div class="cargando" />
                            </div>
                        }
                    </div>
                }

                @if (mostrarGogGalaxy == true)
                {
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-left: 5px;">
                           <i class="fa-brands fa-windows"></i>
                           <div>
                               Windows
                           </div>
                        </div>

                        <ul style="display: grid; gap: 15px; margin-bottom: 30px;">
                            <li>
                                @string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String19", "AccountGames"), "galaxy-2.0.db", "%ProgramData%\\GOG.com\\Galaxy\\storage")
                            </li>

                            <li>
                                <a href="https://support.microsoft.com/en-us/windows/file-explorer-in-windows-ef370130-1cca-9dc5-e0df-2f7416fe1cb1#ID0EDBBBBBFD-button" target="_blank" style="text-decoration: none;">@Herramientas.Idiomas.BuscarTexto(idioma, "String20", "AccountGames")</a>
                            </li>

                            <li>
                                @Herramientas.Idiomas.BuscarTexto(idioma, "String22", "AccountGames")
                            </li>
                        </ul>

                        @if (trabajando == false)
                        {
                            <label class="boton" style="cursor: pointer; font-size: 16px; width: fit-content; padding: 10px 15px;">
                                <InputFile OnChange="GogGalaxyCargarFichero" accept=".db" hidden />
                                @string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String23", "AccountGames"), "galaxy-2.0.db")
                            </label>

                            @if (importados > 0)
                            {
                                <div style="margin-top: 20px;">@string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String24", "AccountGames"), importados)</div>
                            }
                        }
                        else
                        {
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <div class="cargando" />
                            </div>
                        }   
                    </div>     
                }

                @if (mostrarPlaynite == true)
                {
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-left: 5px;">
                           <i class="fa-brands fa-windows"></i>
                           <div>
                               Windows
                           </div>
                        </div>

                        <ul style="display: grid; gap: 15px; margin-bottom: 30px;">
                            <li>
                                @string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String25", "AccountGames"), "games.db", "%appdata%\\Playnite\\library\\")
                            </li>

                            <li>
                                @string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String26", "AccountGames"), "games.db", "C:\\Playnite\\library\\")
                            </li>

                            <li>
                                <a href="https://support.microsoft.com/en-us/windows/file-explorer-in-windows-ef370130-1cca-9dc5-e0df-2f7416fe1cb1#ID0EDBBBBBFD-button" target="_blank" style="text-decoration: none;">@Herramientas.Idiomas.BuscarTexto(idioma, "String20", "AccountGames")</a>
                            </li>

                            <li>
                                @Herramientas.Idiomas.BuscarTexto(idioma, "String22", "AccountGames")
                            </li>
                        </ul>

                        @if (trabajando == false)
                        {
                            <label class="boton" style="cursor: pointer; font-size: 16px; width: fit-content; padding: 10px 15px;">
                                <InputFile OnChange="PlayniteCargarFichero" accept=".db" hidden />
                                @string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String23", "AccountGames"), "games.db")
                            </label>

                            @if (importados > 0)
                            {
                                <div style="margin-top: 20px;">@string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String24", "AccountGames"), importados)</div>
                            }
                        }
                        else
                        {
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <div class="cargando" />
                            </div>
                        }    
                    </div>
                }

                @if (mostrarHeroicGames == true)
                {
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-left: 5px;">
                           <i class="fa-brands fa-windows"></i>
                           <div>
                               Windows
                           </div>
                        </div>

                         <ul style="display: grid; gap: 15px; margin-bottom: 30px;">
                            <li>
                                @string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String19", "AccountGames"), "library.json", "%APPDATA%\\heroic\\nile_config\\nile")
                            </li>

                            <li>
                                <a href="https://support.microsoft.com/en-us/windows/file-explorer-in-windows-ef370130-1cca-9dc5-e0df-2f7416fe1cb1#ID0EDBBBBBFD-button" target="_blank" style="text-decoration: none;">@Herramientas.Idiomas.BuscarTexto(idioma, "String20", "AccountGames")</a>
                            </li>

                            <li>
                                @Herramientas.Idiomas.BuscarTexto(idioma, "String22", "AccountGames")
                            </li>
                        </ul>

                        @if (trabajando == false)
                        {
                            <label class="boton" style="cursor: pointer; font-size: 16px; width: fit-content; padding: 10px 15px;">
                                <InputFile OnChange="HeroicGamesCargarFichero" accept=".json" hidden />
                                @string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String23", "AccountGames"), "library.json")
                            </label>

                            @if (importados > 0)
                            {
                                <div style="margin-top: 20px;">@string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String24", "AccountGames"), importados)</div>
                            }
                        }
                        else
                        {
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <div class="cargando" />
                            </div>
                        }    
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {

    #nullable disable

    [Parameter]
    public string idioma { get; set; }

    private Usuario usuario = new Usuario();

    private bool trabajando = false;
    private int importados = 0;

    protected override async Task OnInitializedAsync()
    {
        usuario = await UserManager.GetUserAsync(HttpContextAccessor.HttpContext.User);
    }

    private void CerrarPestañas()
    {
        mostrarAmazon = false;
        mostrarGogGalaxy = false;
        mostrarPlaynite = false;
        mostrarHeroicGames = false;
    }

    private bool mostrarAmazon = false;

    private void MostrarAmazon(MouseEventArgs e)
    {
        CerrarPestañas();
        mostrarAmazon = true;
    }

    private bool mostrarGogGalaxy = false;

    private void MostrarGogGalaxy(MouseEventArgs e)
    {
        CerrarPestañas();
        mostrarGogGalaxy = true;
    }

    private bool mostrarPlaynite = false;

    private void MostrarPlaynite(MouseEventArgs e)
    {
        CerrarPestañas();
        mostrarPlaynite = true;
    }

    private bool mostrarHeroicGames = false;

    private void MostrarHeroicGames(MouseEventArgs e)
    {
        CerrarPestañas();
        mostrarHeroicGames = true;
    }

    private async void AmazonCargarFichero(InputFileChangeEventArgs e)
    {
        trabajando = true;

        if (e.File.Name.ToLower().Contains("gameuserinteractionsinfo") == true)
        {
            importados = 0;

            IBrowserFile fichero = e.File;
            int maximoTamaño = 268435456; //256 mb;
            byte[] buffer = new byte[fichero.Size];

            Herramientas.Ficheros.LecturaPerezosa stream = new Herramientas.Ficheros.LecturaPerezosa(fichero, maximoTamaño);
            StreamContent contenido = new StreamContent(stream);

            string ubicacion = Path.GetFullPath("./wwwroot/otros/amazon-" + usuario.Id + ".sqlite");
            await File.WriteAllBytesAsync(ubicacion, await contenido.ReadAsByteArrayAsync());

            List<string> listadoIds = new List<string>();

            using (SqliteConnection conexion = new SqliteConnection("Data Source=" + ubicacion))
            {
                conexion.Open();

                SqliteCommand comando = conexion.CreateCommand();
                comando.CommandText = "SELECT * FROM dbset";

                using (SqliteDataReader lector = comando.ExecuteReader())
                {
                    while (lector.Read())
                    {
                        if (lector.IsDBNull(0) == false)
                        {
                            if (string.IsNullOrEmpty(lector.GetString(0)) == false)
                            {
                                listadoIds.Add(lector.GetString(0));
                            }
                        }
                    }
                }
            }

            if (listadoIds.Count > 0)
            {
                SqlConnection conexion = new SqlConnection();

                if (conexion == null)
                {
                    conexion = Herramientas.BaseDatos.Conectar();
                }
                else
                {
                    if (conexion.State != System.Data.ConnectionState.Open)
                    {
                        conexion = Herramientas.BaseDatos.Conectar();
                    }
                }

                string textoIds = string.Empty;

                foreach (string id in listadoIds)
                {
                    BaseDatos.Plataformas.Buscar.Amazon(id, null, conexion);

                    if (string.IsNullOrEmpty(textoIds) == true)
                    {
                        textoIds = id;
                    }
                    else
                    {
                        textoIds = textoIds + "," + id;
                    }

                    importados += 1;
                }

                if (usuario != null)
                {
                    usuario.AmazonGames = textoIds;
                    usuario.AmazonLastImport = DateTime.Now;

                    try
                    {
                        await UserManager.UpdateAsync(usuario);
                    }
                    catch
                    {
                        BaseDatos.Errores.Insertar.Mensaje("Cuenta Amazon Juegos", usuario.Id);
                    }
                }
            }
        }

        trabajando = false;

        await InvokeAsync(() =>
        {
            StateHasChanged();
        });
    }

    private async void GogGalaxyCargarFichero(InputFileChangeEventArgs e)
    {
        trabajando = true;

        if (e.File.Name.ToLower().Contains("galaxy-2.0") == true)
        {
            importados = 0;
            importados = await Herramientas.Ficheros.GogGalaxy.Cargar(JuegoDRM.Amazon, e.File, usuario, UserManager);
        }

        trabajando = false;

        await InvokeAsync(() =>
        {
            StateHasChanged();
        });
    }

    private async void PlayniteCargarFichero(InputFileChangeEventArgs e)
    {
        trabajando = true;

        if (e.File.Name.ToLower().Contains("games") == true)
        {
            importados = 0;
            importados = await Herramientas.Ficheros.Playnite.Cargar(JuegoDRM.Amazon, e.File, usuario, UserManager);
        }

        trabajando = false;

        await InvokeAsync(() =>
        {
            StateHasChanged();
        });
    }

     private async void HeroicGamesCargarFichero(InputFileChangeEventArgs e)
    {
        trabajando = true;

        if (e.File.Name.ToLower().Contains("library") == true)
        {
            importados = 0;
            importados = await Herramientas.Ficheros.HeroicGames.Cargar(JuegoDRM.Amazon, e.File, usuario, UserManager);
        }

        trabajando = false;

        await InvokeAsync(() =>
        {
            StateHasChanged();
        });
    }

    private async Task BorrarJuegos(MouseEventArgs args)
    {
        usuario.AmazonGames = null;

        try
        {
            await UserManager.UpdateAsync(usuario);
        }
        catch
        {
            BaseDatos.Errores.Insertar.Mensaje("Borrar Amazon Juegos", usuario.Id);
        }
    }
}
