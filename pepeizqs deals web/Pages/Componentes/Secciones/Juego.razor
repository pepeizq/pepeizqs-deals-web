@using Bundles2
@using Gratis2
@using Herramientas
@using Juegos
@using Microsoft.AspNetCore.Components.Web;
@using Microsoft.AspNetCore.Identity
@using Microsoft.JSInterop
@using Microsoft.VisualBasic
@using Newtonsoft.Json
@using Suscripciones2
@using System.Net
@using Tiendas2
@using pepeizqs_deals_web.Areas.Identity.Data

@inject UserManager<Usuario> UserManager
@inject SignInManager<Usuario> SignInManager
@inject IHttpContextAccessor HttpContextAccessor
@inject IJSRuntime JS

<div>
	@if (juego.Tipo == JuegoTipo.Game)
	{
		<img class="juego-fondo" src="@Imagenes.DescargarYGuardar(juego.Imagenes.Library_1920x620, "juegos", juego.Id.ToString(), "library_1920x620", dominio).Result"/>
	}

	<div class="juego-contenido">
		<div class="perfil-espacio-bottom juego-cabecera" style="position: -webkit-sticky; position: sticky; top: 70px; z-index: 3;">
			<div class="perfil-flexible-centrado">
				<div class="juego-flexible-izquierda">
					<img src="@Imagenes.DescargarYGuardar(LimpiarImagenJuego(juego.Imagenes.Header_460x215), "juegos", juego.Id.ToString(), "header_460x215", dominio).Result" class="juego-imagen" />
				</div>
				
				<div class="juego-titulo">
					<div>@juego.Nombre</div>

					<div style="margin-right: 10px; margin-top: 10px; display: flex; align-items: center;">
						@foreach (JuegoDRM drm in JuegoDRM2.CargarDRMs())
						{
							@if (drm != JuegoDRM.NoEspecificado)
							{
								@if (VerificarMostrarDRM(idioma, drm, juego) == true)
								{
									@if (drm == JuegoDRM.DRMFree)
									{
										<button onclick="moverScroll('@drm')" class="boton-pequeño" style="width: 40px; height: 40px; text-align: center; padding: 7px; margin-right: 10px;"><div style="font-weight: bold; font-size: 10px;">DRM Free</div></button>
									}
									else
									{
										<button onclick="moverScroll('@drm')" class="boton-pequeño" style="width: 40px; height: 40px; text-align: center; padding: 9px; margin-right: 10px">
											<div style="display: flex; align-items: center;">
												<img src="@JuegoDRM2.SacarImagen(drm)" style="max-width: 100%; max-height: 100%;" />
											</div>
										</button>
									}
								}
							}
						}

						@if (BundlesDisponibles(juego.Bundles).Count > 0)
						{
							<div style="margin-left: 15px; font-size: 16px;">
								<a onclick="moverScroll('bundles')" style="color: var(--colorTextoOscuro); text-decoration: underline; cursor: pointer;">@Idiomas.CogerCadena(idioma, "Layout.Bundles")</a>
							</div>
						}

						@if (GratisDisponibles(juego.Gratis).Count > 0)
						{
							<div style="margin-left: 15px; font-size: 16px;">
								<a onclick="moverScroll('gratis')" style="color: var(--colorTextoOscuro); text-decoration: underline; cursor: pointer;">@Idiomas.CogerCadena(idioma, "Layout.Free")</a>
							</div>
						}

						@if (SuscripcionesDisponibles(juego.Suscripciones).Count > 0)
						{
							<div style="margin-left: 15px; font-size: 16px;">
								<a onclick="moverScroll('suscripciones')" style="color: var(--colorTextoOscuro); text-decoration: underline; cursor: pointer;">@Idiomas.CogerCadena(idioma, "Layout.Subscriptions")</a>
							</div>
						}
					</div>
				</div>

				<div style="text-align: right; min-width: 350px; margin: 10px 20px;">
					@if (juego.Analisis != null)
					{
						<div style="font-size: 14px;">
							<div class="tooltip2 juego-analisis-display">
								<div style="display: flex; align-items: center;">
									@if (int.Parse(juego.Analisis.Porcentaje) > 74)
									{
										<img src="/imagenes/analisis/positive2.webp" class="juego-analisis-imagen" />
									}

									@if (int.Parse(juego.Analisis.Porcentaje) > 49 && int.Parse(juego.Analisis.Porcentaje) < 75)
									{
										<img src="/imagenes/analisis/mixed2.webp" class="juego-analisis-imagen" />
									}

									@if (int.Parse(juego.Analisis.Porcentaje) < 50)
									{
										<img src="/imagenes/analisis/negative2.webp" class="juego-analisis-imagen" />
									}

									<div style="margin-left: 10px;">@juego.Analisis.Porcentaje% • @Calculadora.RedondearAnalisis(idioma, juego.Analisis.Cantidad)</div>
								</div>

								<div class="tooltip-abrir tooltip-abajo" style="padding: 20px; width: 100%;">
									<div class="juego-analisis-texto2">@Idiomas.CogerCadena(idioma, "Game.String2")</div>
								</div>
							</div>
						</div>
					}

					<div style="display: flex; align-items: center; justify-content: right; margin-top: 15px;">
						<div>
							@if (juego.Caracteristicas.Windows == true)
							{
								<img src="/imagenes/sistemas/windows.webp" />
							}

							@if (juego.Caracteristicas.Mac == true)
							{
								<img src="/imagenes/sistemas/mac.webp" />
							}

							@if (juego.Caracteristicas.Linux == true)
							{
								<img src="/imagenes/sistemas/linux.webp" />
							}
						</div>						

						<div style="margin-left: 20px;">
							<label>@Idiomas.CogerCadena(idioma, "Game.String1")</label>

							@if (juego.IdSteam > 0)
							{
								<a class="juego-boton-pequeño" style="margin-left: 10px;" href="@EnlaceAcortador.Generar("https://store.steampowered.com/app/" + juego.IdSteam.ToString(), "steam")" target="_blank">Steam</a>
							}

							@if (string.IsNullOrEmpty(juego.SlugGOG) == false)
							{
								<a class="juego-boton-pequeño" style="margin-left: 10px;" href="@EnlaceAcortador.Generar("https://www.gog.com/game/" + juego.SlugGOG, "gog")" target="_blank">GOG</a>
							}
						</div>
					</div>
				</div>				
			</div>
		</div>

		@foreach (JuegoDRM drm in JuegoDRM2.CargarDRMs())
		{
			@if (drm != JuegoDRM.NoEspecificado)
			{
				@if (VerificarMostrarDRM(idioma, drm, juego) == true)
				{
					<div id="@drm">
						@if (usuarioLogeado == true)
						{
							@if (CargarEstadoDeseado(usuario, juego, drm, idioma).Length > 0)
							{
								<div class="perfil" style="padding: 20px 40px; background-color: var(--fondoAlerta); color: var(--colorTextoAlerta);">
									<div class="perfil-flexible-centrado">
										<i class="fa-solid fa-exclamation" style="font-size: 25px;"></i>

										<label style="text-align: left; padding-left: 25px; width: 100%;">@CargarEstadoDeseado(usuario, juego, drm, idioma)</label>
									</div>
								</div>
							}
							else
							{
								@if (ComprobarSiEstaDeseado(drm) == true)
								{
									<button @onclick="(e => CambiarEstadoDeseado(e, false, drm))" class="boton-pequeño" style="width: auto; padding: 20px 40px;">
										<div class="perfil-flexible-centrado">
											<i class="fa-solid fa-check" style="font-size: 25px;"></i>

											<div style="text-align: left; padding-left: 25px; width: 100%;">@Herramientas.Idiomas.CogerCadena(idioma, "Game.String3")</div>
										</div>
									</button>
								}
								else
								{
									<button @onclick="(e => CambiarEstadoDeseado(e, true, drm))" class="boton-pequeño" style="width: auto; padding: 20px 40px;">@Herramientas.Idiomas.CogerCadena(idioma, "Game.String4")</button>
								}
							}
						}

						<div class="juego-drm-centrado" style="margin-bottom: 50px;">
							<div class="perfil juego-drm-imagen">
								@if (drm == JuegoDRM.DRMFree)
								{
									<div style="font-weight: bold; font-size: 18px;">DRM Free</div>
								}
								else
								{
									<img src="@JuegoDRM2.SacarImagen(drm)" />
								}
							</div>

							<div class="perfil" style="width: 90%;">
								@if (CogerMinimoDRM(idioma, drm, juego.PrecioMinimosHistoricos, juego.PrecioActualesTiendas) != null)
								{
									<div class="juego-minimo">
										@CogerMinimoDRM(idioma, drm, juego.PrecioMinimosHistoricos, juego.PrecioActualesTiendas)
									</div>
								}

								@if (BundlesComprobar(juego.Bundles, drm) != null)
								{
									<div class="juego-minimo">
										<a onclick="moverScroll('bundles')" style="color: var(--colorTextoOscuro); text-decoration: underline; cursor: pointer;">@BundlesPreparar(drm, idioma)</a>
									</div>
								}

								@if (GratisComprobar(juego.Gratis, drm) != null)
								{
									<div class="juego-minimo">
										<a onclick="moverScroll('gratis')" style="color: var(--colorTextoOscuro); text-decoration: underline; cursor: pointer;">@GratisPreparar(drm, idioma)</a>
									</div>
								}

								@if (SuscripcionesComprobar(juego.Suscripciones, drm) != null)
								{
									<div class="juego-minimo">
										<a onclick="moverScroll('suscripciones')" style="color: var(--colorTextoOscuro); text-decoration: underline; cursor: pointer;">@SuscripcionesPreparar(drm, idioma)</a>
									</div>
								}

								@if (OrdenarPrecios(juego.PrecioActualesTiendas, drm).Count > 0)
								{
									@foreach (JuegoPrecio precio in OrdenarPrecios(juego.PrecioActualesTiendas, drm))
									{
										<a class="juego-boton-pequeño juego-imagen-boton-espacio" href="@EnlaceAcortador.Generar(precio.Enlace, precio.Tienda)" target="_blank">
											<div class="perfil-flexible-centrado">
												<div>
													<img src="@SacarImagenTienda(precio.Tienda)" class="juego-imagen-boton" />
													<span style="margin-left: 15px;">@ComprobarEdicion(juego.Nombre, precio.Nombre)</span>
												</div>
												
												<div class="juego-descuento-precio">
													<div style="font-size: 14px; margin: 20px;">
														@Calculadora.HaceTiempo(precio.FechaDetectado, idioma)
													</div>

													<div style="width: 75px; text-align: center;" class="juego-descuento">
														@precio.Descuento.ToString()%
													</div>

													<div class="juego-precio" style="text-align: center;">
														@PrepararPrecio(precio, false)

														@if (precio.Moneda != JuegoMoneda.Euro)
														{
															<br />

															<label style="font-size: 13px;">@Divisas.DevolverSimbolo(precio.Precio, precio.Moneda)</label>
														}
													</div>
												</div>
											</div>
										</a>
									}
								}
								else
								{
									<div>@Idiomas.CogerCadena(idioma, "Game.String12")</div>
								}
							</div>
						</div>
					</div>
				}
			}
		}

		@if (juego.Bundles != null)
		{
			<div id="bundles" class="perfil" style="margin-bottom: 50px;">
				@if (BundlesDisponibles(juego.Bundles).Count > 0)
				{
					<div style="margin-bottom: 10px;">
						<label style="font-size: 18px;">@Idiomas.CogerCadena(idioma, "Game.String22")</label>
					</div>

					@foreach (var bundle2 in BundlesDisponibles(juego.Bundles))
					{
						@foreach (var bundle3 in BundleCargar(bundle2.BundleId))
						{
							<a class="juego-boton-pequeño" href="@EnlaceAcortador.Generar(bundle2.Enlace, bundle3.Tipo)" target="_blank" style="font-size: 16px; padding: 20px 25px; margin-top: 10px; margin-bottom: 10px; cursor: pointer;">
								<div style="display: flex; align-items: center;">
									<div style="margin-right: 15px;">
										<img src="@BundlesCargar.DevolverBundle(bundle3.Tipo).ImagenIcono" style="max-width: 22px; max-height: 22px;" />
									</div>

									<div style="margin-right: 30px;">
										<img src="@JuegoDRM2.SacarImagen(bundle2.DRM)" style="max-width: 22px; max-height: 22px;" />
									</div>

									<div style="margin-right: 20px; width: 100%;">
										<label style="cursor: pointer;">@bundle3.NombreBundle • @bundle3.NombreTienda</label>
									</div>

									<div>
										<label style="cursor: pointer;">@BundlesPrepararPrecio(bundle3, juego.Id)</label>
									</div>
								</div>
							</a>
						}
					}
				}

				@if (BundlesAntiguos(juego.Bundles).Count > 0)
				{
					@if (BundlesDisponibles(juego.Bundles).Count > 0)
					{
						<div style="margin-top: 40px; margin-bottom: 10px;">
							<label style="font-size: 18px;">@Idiomas.CogerCadena(idioma, "Game.String23")</label>
						</div>
					}
					else
					{
						<div style="margin-bottom: 10px;">
							<label style="font-size: 18px;">@Idiomas.CogerCadena(idioma, "Game.String23")</label>
						</div>
					}

					@foreach (var bundle2 in BundlesAntiguos(juego.Bundles))
					{
						@foreach (var bundle3 in BundleCargar(bundle2.BundleId))
						{
							<a class="juego-boton-pequeño" href="/bundle/@bundle2.BundleId.ToString()" style="font-size: 17px; padding: 20px 25px; margin-top: 10px; margin-bottom: 10px;">
								<div style="display: flex; align-items: center;">
									<div style="margin-right: 15px;">
										<img src="@BundlesCargar.DevolverBundle(bundle3.Tipo).ImagenIcono" style="max-width: 22px; max-height: 22px;" />
									</div>

									<div style="margin-right: 30px;">
										<img src="@JuegoDRM2.SacarImagen(bundle2.DRM)" style="max-width: 22px; max-height: 22px;" />
									</div>

									<div style="margin-right: 20px; width: 100%;">
										<label style="cursor: pointer;">@bundle3.NombreBundle • @bundle3.NombreTienda</label><br />
										<label style="font-size: 13px; cursor: pointer;">@Calculadora.HaceTiempo(bundle3.FechaTermina, idioma)</label>
									</div>

									<div>
										<label style="cursor: pointer;">@BundlesPrepararPrecio(bundle3, juego.Id)</label>
									</div>
								</div>
							</a>
						}
					}
				}			
			</div>
		}

		@if (juego.Gratis != null)
		{
			<div id="gratis" class="perfil" style="margin-bottom: 50px;">
				@if (GratisDisponibles(juego.Gratis).Count > 0)
				{
					<div style="margin-bottom: 10px;">
						<label style="font-size: 18px;">@Idiomas.CogerCadena(idioma, "Game.String30")</label>
					</div>

					@foreach (var gratis2 in GratisDisponibles(juego.Gratis))
					{
						<a class="juego-boton-pequeño" href="@EnlaceAcortador.Generar(gratis2.Enlace, gratis2.Tipo)" target="_blank" style="font-size: 16px; padding: 20px 25px; margin-top: 10px; margin-bottom: 10px; cursor: pointer;">
							<div style="display: flex; align-items: center;">
								<div style="margin-right: 15px;">
									<img src="@GratisCargar.DevolverGratis(gratis2.Tipo).ImagenIcono" style="max-width: 22px; max-height: 22px;" />
								</div>

								<div style="margin-right: 30px;">
									<img src="@JuegoDRM2.SacarImagen(gratis2.DRM)" style="max-width: 22px; max-height: 22px;" />
								</div>

								<div style="margin-right: 20px; width: 100%;">
									<label style="cursor: pointer;">@GratisCargar.DevolverGratis(gratis2.Tipo).Nombre</label>
								</div>
							</div>
						</a>
					}
				}

				@if (GratisAntiguos(juego.Gratis).Count > 0)
				{
					@if (GratisDisponibles(juego.Gratis).Count > 0)
					{
						<div style="margin-top: 40px; margin-bottom: 10px;">
							<label style="font-size: 18px;">@Idiomas.CogerCadena(idioma, "Game.String31")</label>
						</div>
					}
					else
					{
						<div style="margin-bottom: 10px;">
							<label style="font-size: 18px;">@Idiomas.CogerCadena(idioma, "Game.String31")</label>
						</div>
					}

					@foreach (var gratis2 in GratisAntiguos(juego.Gratis))
					{
						<div style="display: flex; align-items: center; font-size: 16px; padding: 15px 5px; margin-top: 10px; margin-bottom: 10px;">
							<div style="margin-right: 15px;">
								<img src="@GratisCargar.DevolverGratis(gratis2.Tipo).ImagenIcono" style="max-width: 22px; max-height: 22px;" />
							</div>

							<div style="margin-right: 30px;">
								<img src="@JuegoDRM2.SacarImagen(gratis2.DRM)" style="max-width: 22px; max-height: 22px;" />
							</div>

							<div style="margin-right: 20px; width: 100%;">
								<label>@GratisCargar.DevolverGratis(gratis2.Tipo).Nombre</label><br />
								<label style="font-size: 13px;">@Calculadora.HaceTiempo(gratis2.FechaTermina, idioma)</label>
							</div>
						</div>
					}
				}
			</div>
		}

		@if (juego.Suscripciones != null)
		{
			<div id="suscripciones" class="perfil" style="margin-bottom: 50px;">
				@if (SuscripcionesDisponibles(juego.Suscripciones).Count > 0)
				{
					<div style="margin-bottom: 10px;">
						<label style="font-size: 18px;">@Idiomas.CogerCadena(idioma, "Game.String26")</label>
					</div>

					@foreach (var suscripcion2 in SuscripcionesDisponibles(juego.Suscripciones))
					{
						<a class="juego-boton-pequeño" href="@EnlaceAcortador.Generar(suscripcion2.Enlace, suscripcion2.Tipo)" target="_blank" style="font-size: 16px; padding: 20px 25px; margin-top: 10px; margin-bottom: 10px; cursor: pointer;">
							<div style="display: flex; align-items: center;">
								<div style="margin-right: 15px;">
									<img src="@SuscripcionesCargar.DevolverSuscripcion(suscripcion2.Tipo).ImagenIcono" style="max-width: 22px; max-height: 22px;" />
								</div>

								<div style="margin-right: 30px;">
									<img src="@JuegoDRM2.SacarImagen(suscripcion2.DRM)" style="max-width: 22px; max-height: 22px;" />
								</div>

								<div style="margin-right: 20px; width: 100%;">
									<label style="cursor: pointer;">@SuscripcionesCargar.DevolverSuscripcion(suscripcion2.Tipo).Nombre</label>
								</div>
							</div>
						</a>
					}
				}

				@if (SuscripcionesAntiguos(juego.Suscripciones).Count > 0)
				{
					@if (SuscripcionesDisponibles(juego.Suscripciones).Count > 0)
					{
						<div style="margin-top: 40px; margin-bottom: 10px;">
							<label style="font-size: 18px;">@Idiomas.CogerCadena(idioma, "Game.String27")</label>
						</div>
					}
					else
					{
						<div style="margin-bottom: 10px;">
							<label style="font-size: 18px;">@Idiomas.CogerCadena(idioma, "Game.String27")</label>
						</div>
					}

					@foreach (var suscripcion2 in SuscripcionesAntiguos(juego.Suscripciones))
					{
						<div style="display: flex; align-items: center; font-size: 16px; padding: 5px 15px; margin-top: 10px; margin-bottom: 10px;">
							<div style="margin-right: 15px;">
								<img src="@SuscripcionesCargar.DevolverSuscripcion(suscripcion2.Tipo).ImagenIcono" style="max-width: 22px; max-height: 22px;" />
							</div>

							<div style="margin-right: 30px;">
								<img src="@JuegoDRM2.SacarImagen(suscripcion2.DRM)" style="max-width: 22px; max-height: 22px;" />
							</div>

							<div style="margin-right: 20px; width: 100%;">
								<label>@SuscripcionesCargar.DevolverSuscripcion(suscripcion2.Tipo).Nombre</label><br />
								<label style="font-size: 13px;">@Calculadora.HaceTiempo(suscripcion2.FechaTermina, idioma)</label>
							</div>
						</div>
					}
				}
			</div>
		}

		@if (juego.Caracteristicas.Descripcion != null)
		{
			<div class="perfil perfil-flexible-centrado" style="margin-bottom: 50px;">
				<div style="width: 100%; padding: 10px;">
					@WebUtility.HtmlDecode(juego.Caracteristicas.Descripcion)
				</div>
			</div>
		}

		@if (juego.Media != null)
		{
			@if (juego.Media.Capturas != null)
			{
				@if (juego.Media.Capturas.Count > 0)
				{
					<div class="perfil">
						<div class="juego-galeria-contenedor">
							@for (int i = 0; i < juego.Media.Capturas.Count; i++)
							{
								<div class="juego-galeria-imagenes">
									<div class="juego-galeria-numero">@(i + 1) / @juego.Media.Capturas.Count</div>
									<img src="@Imagenes.DescargarYGuardar(juego.Media.Capturas[i], "juegos", juego.Id.ToString(), "captura" + i.ToString(), dominio).Result" style="width: 100%;">
								</div>
							}

							<a class="juego-galeria-atras" onclick="siguienteAtras(-1)">&#10094;</a>
							<a class="juego-galeria-siguiente" onclick="siguienteAtras(1)">&#10095;</a>

							<div class="juego-galeria-contenedor-texto">
								<p id="juego-galeria-texto"></p>
							</div>

							@if (juego.Media.Miniaturas != null)
							{
								<div class="juego-galeria-fila">
									@for (int i = 0; i < juego.Media.Miniaturas.Count; i++)
									{
										<div class="juego-galeria-columna">
											<img class="juego-galeria-capturas juego-galeria-cursor" src="@Imagenes.DescargarYGuardar(juego.Media.Miniaturas[i], "juegos", juego.Id.ToString(), "miniatura" + i.ToString(), dominio).Result" style="width: 100%;" onclick="cambiarImagen(@i + 1)">
										</div>
									}
								</div>
							}
						</div>
					</div>
				}
			}
		}
	</div>
</div>

<script>
	let imagenPosicion = 1;
	cargarImagen(imagenPosicion);

	function siguienteAtras(n) {
		cargarImagen(imagenPosicion += n);
	}

	function cambiarImagen(n) {
		cargarImagen(imagenPosicion = n);
	}

	function cargarImagen(n) {
		let i;
		let imagenes = document.getElementsByClassName("juego-galeria-imagenes");
		let capturas = document.getElementsByClassName("juego-galeria-capturas");
		let texto = document.getElementById("juego-galeria-texto");

		if (n > imagenes.length) {
			imagenPosicion = 1
		}

		if (n < 1) {
			imagenPosicion = imagenes.length
		}

		for (i = 0; i < imagenes.length; i++) {
			imagenes[i].style.display = "none";
		}

		for (i = 0; i < capturas.length; i++) {
			capturas[i].className = capturas[i].className.replace(" juego-galeria-activo", "");
		}

		imagenes[imagenPosicion - 1].style.display = "block";
		capturas[imagenPosicion - 1].className += " juego-galeria-activo";
		texto.innerHTML = capturas[imagenPosicion - 1].alt;
	}

	function moverScroll(id) {
		const yOffset = -175;
		const element = document.getElementById(id);
		const y = element.getBoundingClientRect().top + window.pageYOffset + yOffset;

		window.scrollTo({ top: y, behavior: 'smooth' });
	}
</script>

@code {

	#nullable disable

	[Parameter]
	public string idioma { get; set; }

	[Parameter]
	public string dominio { get; set; }

	[Parameter]
	public Juegos.Juego juego { get; set; }

	private Usuario usuario = new Usuario();
	private bool usuarioLogeado = false;

	protected override void OnInitialized()
	{
		usuario = UserManager.GetUserAsync(HttpContextAccessor.HttpContext.User).Result;

		if (usuario != null)
		{
			usuarioLogeado = true;
		}
	}

	protected override async void OnAfterRender(bool firstRender)
	{
		base.OnAfterRender(firstRender);
		await JS.InvokeAsync<string>("cargarImagen", "1");
	}

	public static string LimpiarImagenJuego(string enlace)
	{
		if (enlace.Contains("/header_alt_") == true)
		{
			int int1 = enlace.IndexOf("/header_alt_");
			enlace = enlace.Remove(int1, enlace.Length - int1);

			enlace = enlace + "/header.jpg";
		}

		return enlace;
	}

	public bool VerificarMostrarDRM(string idioma, JuegoDRM drm, global::Juegos.Juego juego)
	{
		bool mostrar = false;

		if (CogerMinimoDRM(idioma, drm, juego.PrecioMinimosHistoricos, juego.PrecioActualesTiendas) != null)
		{
			mostrar = true;
		}
		else if (BundlesComprobar(juego.Bundles, drm) != null)
		{
			mostrar = true;
		}
		else if (GratisComprobar(juego.Gratis, drm) != null)
		{
			mostrar = true;
		}
		else if (SuscripcionesComprobar(juego.Suscripciones, drm) != null)
		{
			mostrar = true;
		}

		return mostrar;
	}

	public static string CogerMinimoDRM(string idioma, JuegoDRM drm, List<JuegoPrecio> historicos, List<JuegoPrecio> actuales)
	{
		string drmPreparado = null;

		List<JuegoPrecio> historicosOrdenados = new List<JuegoPrecio>();

		if (historicos != null)
		{
			if (historicos.Count > 0)
			{
				foreach (JuegoPrecio historico in historicos)
				{
					if (historico.DRM == drm)
					{
						historicosOrdenados.Add(historico);
					}
				}
			}
		}

		if (historicosOrdenados.Count == 0)
		{
			if (actuales != null)
			{
				if (actuales.Count > 0)
				{
					historicosOrdenados = OrdenarPrecios(actuales, drm);
				}
			}			
		}

		if (historicosOrdenados.Count > 0)
		{
			// if (historicosOrdenados.Count > 1)
			// {
			// 	historicosOrdenados = OrdenarPrecios(historicosOrdenados, drm);
			// }		

			if (historicosOrdenados[0] != null)
			{
				drmPreparado = Idiomas.CogerCadena(idioma, "Game.String10") + " " + JuegoDRM2.DevolverDRM(drm) + ": " + PrepararPrecio(historicosOrdenados[0], true);

				bool incluirTiempo = true;

				List<JuegoPrecio> actualesOrdenados = OrdenarPrecios(actuales, drm);

				if (actualesOrdenados != null)
				{
					if (actualesOrdenados.Count > 0)
					{
						if (actuales.Count > 0)
						{
							foreach (JuegoPrecio actual in actualesOrdenados)
							{
								if (actual.DRM == drm)
								{
									if (actual.Precio == historicosOrdenados[0].Precio)
									{
										incluirTiempo = false;
									}
								}
							}
						}
					}
				}

				if (incluirTiempo == true)
				{
					List<Tienda> tiendas = TiendasCargar.GenerarListado();
					string tiendaFinal = string.Empty;

					foreach (var tienda in tiendas)
					{
						if (tienda.Id == historicosOrdenados[0].Tienda)
						{
							tiendaFinal = tienda.Nombre;
						}
					}

					drmPreparado = drmPreparado + " (" + Calculadora.HaceTiempo(historicosOrdenados[0].FechaDetectado, idioma) + " " + Idiomas.CogerCadena(idioma, "Game.String13") + " " + tiendaFinal + ")";
				}
				else
				{
					drmPreparado = drmPreparado + " (" + Idiomas.CogerCadena(idioma, "Game.String11") + ")";
				}
			}		
		}

		return drmPreparado;
	}

	public static string PrepararPrecio(JuegoPrecio precio, bool historico)
	{
		string precioTexto = string.Empty;

		if (historico == true)
		{
			precioTexto = precio.Precio.ToString();
		}
		else
		{
			if (precio.Moneda != JuegoMoneda.Euro)
			{
				precioTexto = precio.PrecioCambiado.ToString();
			}
			else
			{
				precioTexto = precio.Precio.ToString();
			}
		}

		precioTexto = precioTexto.Replace(".", ",");

		int int1 = precioTexto.IndexOf(",");

		if (int1 == precioTexto.Length - 2)
		{
			precioTexto = precioTexto + "0";
		}

		precioTexto = precioTexto + "€";

		return precioTexto;
	}

	public static List<JuegoPrecio> OrdenarPrecios(List<JuegoPrecio> precios, JuegoDRM drm)
	{
		List<JuegoPrecio> preciosOrdenados = new List<JuegoPrecio>();

		if (precios != null)
		{
			if (precios.Count > 0)
			{
				foreach (JuegoPrecio precio in precios)
				{
					if (precio.DRM == drm && precio.Descuento > 0)
					{
						bool fechaEncaja = JuegoFicha.CalcularAntiguedad(precio);

						if (fechaEncaja == true)
						{
							JuegoPrecio nuevoPrecio = precio;

							if (nuevoPrecio != null)
							{
								if (nuevoPrecio.Moneda != JuegoMoneda.Euro)
								{
									nuevoPrecio.PrecioCambiado = Divisas.Cambio(nuevoPrecio.Precio, nuevoPrecio.Moneda);
								}
							}

							bool verificacionFinal = true;

							if (preciosOrdenados.Count > 0)
							{
								foreach (var ordenado in preciosOrdenados)
								{
									if (ordenado.Enlace == nuevoPrecio.Enlace && ordenado.Tienda == nuevoPrecio.Tienda && ordenado.DRM == nuevoPrecio.DRM)
									{
										verificacionFinal = false;
										break;
									}
								}
							}

							if (drm == JuegoDRM.NoEspecificado)
							{
								verificacionFinal = false;
							}

							if (verificacionFinal == true)
							{
								preciosOrdenados.Add(nuevoPrecio);
							}
						}
					}
				}
			}
		}

		if (preciosOrdenados.Count > 0)
		{
			preciosOrdenados.Sort(delegate (JuegoPrecio p1, JuegoPrecio p2)
			{
				decimal precio1 = 0;

				if (p1.Moneda != JuegoMoneda.Euro)
				{
					precio1 = p1.PrecioCambiado;
				}
				else
				{
					precio1 = p1.Precio;
				}

				decimal precio2 = 0;

				if (p2.Moneda != JuegoMoneda.Euro)
				{
					precio2 = p2.PrecioCambiado;
				}
				else
				{
					precio2 = p2.Precio;
				}

				if (precio1 == precio2)
				{
					return p2.FechaDetectado.CompareTo(p1.FechaDetectado);
				}
				else
				{
					return precio1.CompareTo(precio2);
				}
			});
		}

		return preciosOrdenados;
	}

	public static string SacarImagenTienda(string codigo)
	{
		string imagen = string.Empty;

		List<Tienda> tiendas = TiendasCargar.GenerarListado();

		foreach (var tienda in tiendas)
		{
			if (tienda.Id == codigo)
			{
				imagen = tienda.Imagen300x80;
			}
		}

		return imagen;
	}

	private static string ComprobarEdicion(string juego, string oferta)
	{
		if (Buscador.LimpiarNombre(juego) != Buscador.LimpiarNombre(oferta))
		{
			string nuevoTexto = oferta.Replace(juego, null);
			nuevoTexto = nuevoTexto.Trim();
			return nuevoTexto;
		}

		return null;
	}

	#region Deseados

	private static string CargarEstadoDeseado(Usuario usuario, Juegos.Juego juego, JuegoDRM drm, string idioma)
	{
		string mensaje = string.Empty;

		if (juego.IdSteam > 0 && drm == Juegos.JuegoDRM.Steam)
		{
			if (usuario.SteamGames != null)
			{
				List<string> juegosSteam = GenerarLista(usuario.SteamGames);

				if (juegosSteam.Count > 0)
				{
					foreach (var juegoSteam in juegosSteam)
					{
						if (int.Parse(juegoSteam) == juego.IdSteam)
						{
							if (juego.Tipo == Juegos.JuegoTipo.Game)
							{
								mensaje = Herramientas.Idiomas.CogerCadena(idioma, "Game.String5");
							}
							else if (juego.Tipo == Juegos.JuegoTipo.DLC)
							{
								mensaje = Herramientas.Idiomas.CogerCadena(idioma, "Game.String6");
							}

							break;
						}
					}
				}
			}
		}

		if (mensaje == string.Empty)
		{
			List<string> deseadosSteam = GenerarLista(usuario.SteamWishlist);

			if (deseadosSteam.Count > 0)
			{
				foreach (var deseado in deseadosSteam)
				{
					if (juego.IdSteam > 0)
					{
						if (juego.IdSteam == int.Parse(deseado) && drm == Juegos.JuegoDRM.Steam)
						{
							if (juego.Tipo == Juegos.JuegoTipo.Game)
							{
								mensaje = Herramientas.Idiomas.CogerCadena(idioma, "Game.String7");
							}
							else if (juego.Tipo == Juegos.JuegoTipo.DLC)
							{
								mensaje = Herramientas.Idiomas.CogerCadena(idioma, "Game.String8");
							}

							break;
						}
					}
				}
			}
		}

		return mensaje;
	}

	private static List<string> GenerarLista(string contenido)
	{
		List<string> lista = new List<string>();

		if (contenido != null)
		{
			int i = 0;
			int j = 100000;

			while (i < j)
			{
				if (contenido.Contains(",") == true)
				{
					int int1 = contenido.IndexOf(",");
					string temp1 = contenido.Remove(int1, contenido.Length - int1);
					lista.Add(temp1);

					contenido = contenido.Remove(0, int1 + 1);
				}
				else
				{
					lista.Add(contenido);
					break;
				}

				i += 1;
			}
		}

		return lista;
	}

	private bool ComprobarSiEstaDeseado(JuegoDRM drm)
	{
		bool estado = false;
		List<Juegos.JuegoDeseado> deseados = new List<Juegos.JuegoDeseado>();

		if (usuario.Wishlist != null)
		{
			deseados = JsonConvert.DeserializeObject<List<Juegos.JuegoDeseado>>(usuario.Wishlist);
		}

		if (deseados.Count > 0)
		{
			foreach (var deseado in deseados)
			{
				if (juego.Id == int.Parse(deseado.IdBaseDatos))
				{
					if (drm == deseado.DRM)
					{						
						estado = true;
						break;
					}
				}
			}
		}

		return estado;
	}

	private async void CambiarEstadoDeseado(MouseEventArgs e, bool estado, JuegoDRM drm)
	{
		List<Juegos.JuegoDeseado> deseados = new List<Juegos.JuegoDeseado>();

		if (usuario.Wishlist != null)
		{
			deseados = JsonConvert.DeserializeObject<List<Juegos.JuegoDeseado>>(usuario.Wishlist);
		}

		Herramientas.Deseados.ActualizarJuegoConUsuarios(juego, drm, usuario, estado);

		if (estado == true)
		{
			bool añadir = true;

			if (deseados.Count > 0)
			{
				foreach (var deseado in deseados)
				{
					if (int.Parse(deseado.IdBaseDatos) == juego.Id && deseado.DRM == drm)
					{
						añadir = false;
					}
				}
			}

			if (añadir == true)
			{
				Juegos.JuegoDeseado deseado = new Juegos.JuegoDeseado();
				deseado.IdBaseDatos = juego.Id.ToString();
				deseado.DRM = drm;

				deseados.Add(deseado);
			}

			usuario.Wishlist = JsonConvert.SerializeObject(deseados);

			await UserManager.UpdateAsync(usuario);
		}
		else
		{
			int posicion = -1;

			if (deseados.Count > 0)
			{
				for (int i = 0; i < deseados.Count; i += 1)
				{
					if (int.Parse(deseados[i].IdBaseDatos) == juego.Id && deseados[i].DRM == drm)
					{
						posicion = i;
					}
				}
			}

			if (posicion >= 0)
			{
				deseados.RemoveAt(posicion);
			}

			usuario.Wishlist = JsonConvert.SerializeObject(deseados);

			await UserManager.UpdateAsync(usuario);
		}
	}

	#endregion

	#region Bundles

	private static List<Bundle> BundleCargar(int id)
	{
		List<Bundle> bundle = new List<Bundle>();
		bundle.Add(global::BaseDatos.Bundles.Buscar.UnBundle(id));

		return bundle;
	}

	public string BundlesComprobar(List<JuegoBundle> listaBundles, JuegoDRM drm)
	{
		if (listaBundles != null)
		{
			if (listaBundles.Count > 0)
			{
				foreach (var bundle in listaBundles)
				{
					if (drm == bundle.DRM)
					{
						return "bundle";
					}
				}
			}
		}

		return null;
	}

	public string BundlesPreparar(JuegoDRM drm, string idioma)
	{
		@if (BundlesDisponibles(juego.Bundles, drm) != null)
		{
			@if (BundlesDisponibles(juego.Bundles, drm).Count > 0)
			{
				return Idiomas.CogerCadena(idioma, "Game.String20");
			}
		}

		@if (BundlesAntiguos(juego.Bundles, drm) != null)
		{
			@if (BundlesAntiguos(juego.Bundles, drm).Count > 0)
			{
				return Idiomas.CogerCadena(idioma, "Game.String21");
			}
		}

		return null;
	}

	public List<JuegoBundle> BundlesDisponibles(List<JuegoBundle> listaBundles, JuegoDRM drm = 0)
	{
		List<JuegoBundle> bundlesDisponibles = new List<JuegoBundle>();

		if (listaBundles != null)
		{
			if (listaBundles.Count > 0)
			{
				foreach (var bundle in listaBundles)
				{
					if (DateTime.Now >= bundle.FechaEmpieza && DateTime.Now <= bundle.FechaTermina)
					{
						if (drm != 0)
						{
							if (bundle.DRM == drm)
							{
								bundlesDisponibles.Add(bundle);
							}
						}
						else
						{
							bundlesDisponibles.Add(bundle);
						}
					}					
				}
			}
		}

		return bundlesDisponibles;
	}

	public List<JuegoBundle> BundlesAntiguos(List<JuegoBundle> listaBundles, JuegoDRM drm = 0)
	{
		List<JuegoBundle> bundlesAntiguos = new List<JuegoBundle>();

		if (listaBundles != null)
		{
			if (listaBundles.Count > 0)
			{
				foreach (var bundle in listaBundles)
				{
					if (DateTime.Now > bundle.FechaTermina)
					{
						if (drm != 0)
						{
							if (bundle.DRM == drm)
							{
								bundlesAntiguos.Add(bundle);
							}
						}
						else
						{
							bundlesAntiguos.Add(bundle);
						}
					}
				}
			}
		}

		return bundlesAntiguos;
	}

	public string BundlesPrepararPrecio(Bundle bundle, int juegoId)
	{
		foreach (var juego in bundle.Juegos)
		{
			if (juegoId.ToString() == juego.JuegoId)
			{
				string precioTexto = juego.Tier.Precio;

				if (precioTexto != null)
				{
					precioTexto = precioTexto.Replace(".", ",");

					if (precioTexto.Contains(",") == true)
					{
						int int1 = precioTexto.IndexOf(",");

						if (int1 == precioTexto.Length - 2)
						{
							precioTexto = precioTexto + "0";
						}
					}

					precioTexto = precioTexto + "€";
					return precioTexto;
				}
			}
		}

		return null;
	}

	#endregion 

	#region Gratis

	public string GratisComprobar(List<JuegoGratis> listaGratis, JuegoDRM drm)
	{
		if (listaGratis != null)
		{
			if (listaGratis.Count > 0)
			{
				foreach (var gratis in listaGratis)
				{
					if (drm == gratis.DRM)
					{
						return "gratis";
					}
				}
			}
		}

		return null;
	}

	public string GratisPreparar(JuegoDRM drm, string idioma)
	{
		@if (GratisDisponibles(juego.Gratis, drm) != null)
		{
			@if (GratisDisponibles(juego.Gratis, drm).Count > 0)
			{
				return Idiomas.CogerCadena(idioma, "Game.String28");
			}
		}

		@if (GratisAntiguos(juego.Gratis, drm) != null)
		{
			@if (GratisAntiguos(juego.Gratis, drm).Count > 0)
			{
				return Idiomas.CogerCadena(idioma, "Game.String29");
			}
		}

		return null;
	}

	public List<JuegoGratis> GratisDisponibles(List<JuegoGratis> listaGratis, JuegoDRM drm = 0)
	{
		List<JuegoGratis> gratisDisponibles = new List<JuegoGratis>();

		if (listaGratis != null)
		{
			if (listaGratis.Count > 0)
			{
				foreach (var gratis in listaGratis)
				{
					if (DateTime.Now >= gratis.FechaEmpieza && DateTime.Now <= gratis.FechaTermina)
					{
						if (drm != 0)
						{
							if (gratis.DRM == drm)
							{
								gratisDisponibles.Add(gratis);
							}
						}
						else
						{
							gratisDisponibles.Add(gratis);
						}
					}
				}
			}
		}

		return gratisDisponibles;
	}

	public List<JuegoGratis> GratisAntiguos(List<JuegoGratis> listaGratis, JuegoDRM drm = 0)
	{
		List<JuegoGratis> gratisAntiguos = new List<JuegoGratis>();

		if (listaGratis != null)
		{
			if (listaGratis.Count > 0)
			{
				foreach (var gratis in listaGratis)
				{
					if (DateTime.Now > gratis.FechaTermina)
					{
						if (drm != 0)
						{
							if (gratis.DRM == drm)
							{
								gratisAntiguos.Add(gratis);
							}
						}
						else
						{
							gratisAntiguos.Add(gratis);
						}
					}
				}
			}
		}

		return gratisAntiguos;
	}

	#endregion

	#region Suscripciones

	public string SuscripcionesComprobar(List<JuegoSuscripcion> listaSuscripciones, JuegoDRM drm)
	{
		if (listaSuscripciones != null)
		{
			if (listaSuscripciones.Count > 0)
			{
				foreach (var suscripciones in listaSuscripciones)
				{
					if (drm == suscripciones.DRM)
					{
						return "suscripcion";
					}
				}
			}
		}

		return null;
	}

	public string SuscripcionesPreparar(JuegoDRM drm, string idioma)
	{
		@if (SuscripcionesDisponibles(juego.Suscripciones, drm) != null)
		{
			@if (SuscripcionesDisponibles(juego.Suscripciones, drm).Count > 0)
			{
				return Idiomas.CogerCadena(idioma, "Game.String24");
			}
		}

		@if (SuscripcionesAntiguos(juego.Suscripciones, drm) != null)
		{
			@if (SuscripcionesAntiguos(juego.Suscripciones, drm).Count > 0)
			{
				return Idiomas.CogerCadena(idioma, "Game.String25");
			}
		}

		return null;
	}

	public List<JuegoSuscripcion> SuscripcionesDisponibles(List<JuegoSuscripcion> listaSuscripciones, JuegoDRM drm = 0)
	{
		List<JuegoSuscripcion> suscripcionesDisponibles = new List<JuegoSuscripcion>();

		if (listaSuscripciones != null)
		{
			if (listaSuscripciones.Count > 0)
			{
				foreach (var suscripcion in listaSuscripciones)
				{
					if (DateTime.Now >= suscripcion.FechaEmpieza && DateTime.Now <= suscripcion.FechaTermina)
					{
						if (drm != 0)
						{
							if (suscripcion.DRM == drm)
							{
								suscripcionesDisponibles.Add(suscripcion);
							}
						}
						else
						{
							suscripcionesDisponibles.Add(suscripcion);
						}
					}
				}
			}
		}

		return suscripcionesDisponibles;
	}

	public List<JuegoSuscripcion> SuscripcionesAntiguos(List<JuegoSuscripcion> listaSuscripciones, JuegoDRM drm = 0)
	{
		List<JuegoSuscripcion> suscripcionesAntiguas = new List<JuegoSuscripcion>();

		if (listaSuscripciones != null)
		{
			if (listaSuscripciones.Count > 0)
			{
				foreach (var suscripcion in listaSuscripciones)
				{
					if (DateTime.Now > suscripcion.FechaTermina)
					{
						if (drm != 0)
						{
							if (suscripcion.DRM == drm)
							{
								suscripcionesAntiguas.Add(suscripcion);
							}
						}
						else
						{
							suscripcionesAntiguas.Add(suscripcion);
						}
					}
				}
			}
		}

		return suscripcionesAntiguas;
	}

	#endregion
}
